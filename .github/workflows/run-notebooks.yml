name: Run Notebooks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  execute-notebooks:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy pandas scikit-learn imbalanced-learn matplotlib seaborn
          pip install jupyterlab ipykernel papermill nbconvert
          pip install xgboost lightgbm

      - name: Create output directories
        run: |
          mkdir -p notebooks/_executed
          mkdir -p results

      - name: Execute Notebook 01
        run: |
          papermill notebooks/01_analise_comparativa_tecnicas.ipynb \
            notebooks/_executed/01_analise_comparativa_tecnicas.executed.ipynb \
            -k python3
        continue-on-error: true

      - name: Execute Notebook 02
        run: |
          papermill notebooks/02_estrategia_maximo_recall.ipynb \
            notebooks/_executed/02_estrategia_maximo_recall.executed.ipynb \
            -k python3
        continue-on-error: true

      - name: Execute Notebook 03
        run: |
          papermill notebooks/03_estrategia_maxima_precisao.ipynb \
            notebooks/_executed/03_estrategia_maxima_precisao.executed.ipynb \
            -k python3
        continue-on-error: true

      - name: Convert to HTML
        run: |
          for nb in notebooks/_executed/*.executed.ipynb; do
            jupyter nbconvert --to html "$nb" || true
          done

      - name: Upload executed notebooks
        uses: actions/upload-artifact@v4
        with:
          name: executed-notebooks
          path: notebooks/_executed/
          retention-days: 30

      - name: Upload results JSON
        uses: actions/upload-artifact@v4
        with:
          name: results
          path: results/
          retention-days: 30
          if-no-files-found: ignore
